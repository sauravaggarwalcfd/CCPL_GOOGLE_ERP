<script>
/* ============================================================
   CC ERP v6 â€” Client-Side JavaScript
   Vanilla JS â€” Matches CC_ERP_Main.jsx pixel-perfect
   Wired to google.script.run APIs
   ============================================================ */

// â”€â”€â”€ COLOUR SYSTEM (exact from JSX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var MODES = {
  light:    {id:"light",    lbl:"â˜€ï¸", name:"Light",      bg:"#f0f2f5",shellBg:"#ffffff",shellBd:"#e2e4e8",sidebarBg:"#ffffff",sidebarBd:"#e2e4e8",surfHigh:"#ffffff",surfMid:"#f7f8fa",surfLow:"#f0f2f5",hoverBg:"#eef1f8",inputBg:"#ffffff",inputBd:"#d1d5db",dropBg:"#ffffff",divider:"#e5e7eb",tblHead:"#f4f5f7",tblEven:"#ffffff",tblOdd:"#fafbfc",statusBg:"#f0f2f5",badgeBg:"#e5e7eb",badgeTx:"#374151",textA:"#111827",textB:"#374151",textC:"#6b7280",textD:"#9ca3af",scrollThumb:"#d1d5db",shadow:"0 4px 20px rgba(0,0,0,.09)"},
  black:    {id:"black",    lbl:"â¬›", name:"Black",      bg:"#000000",shellBg:"#0a0a0a",shellBd:"#1c1c1c",sidebarBg:"#0a0a0a",sidebarBd:"#1c1c1c",surfHigh:"#111111",surfMid:"#161616",surfLow:"#0a0a0a",hoverBg:"#1c1c1c",inputBg:"#0d0d0d",inputBd:"#2a2a2a",dropBg:"#111111",divider:"#1f1f1f",tblHead:"#0d0d0d",tblEven:"#111111",tblOdd:"#141414",statusBg:"#0a0a0a",badgeBg:"#1c1c1c",badgeTx:"#888888",textA:"#f0f0f0",textB:"#a0a0a0",textC:"#666666",textD:"#444444",scrollThumb:"#2a2a2a",shadow:"0 4px 28px rgba(0,0,0,.85)"},
  lightgrey:{id:"lightgrey",lbl:"ğŸ©¶", name:"Light Grey", bg:"#e4e7ec",shellBg:"#f2f3f5",shellBd:"#d4d6dc",sidebarBg:"#f2f3f5",sidebarBd:"#d4d6dc",surfHigh:"#f8f9fa",surfMid:"#eef0f3",surfLow:"#e4e7ec",hoverBg:"#e0e4ef",inputBg:"#f8f9fa",inputBd:"#c8cdd8",dropBg:"#f8f9fa",divider:"#d4d6dc",tblHead:"#ebedf0",tblEven:"#f8f9fa",tblOdd:"#f0f2f5",statusBg:"#e4e7ec",badgeBg:"#d4d6dc",badgeTx:"#3d4460",textA:"#1a1f2e",textB:"#3d4460",textC:"#6b7590",textD:"#9ba3b8",scrollThumb:"#c0c5d4",shadow:"0 4px 16px rgba(0,0,0,.08)"},
  midnight: {id:"midnight", lbl:"ğŸŒ™", name:"Midnight",   bg:"#0d1117",shellBg:"#161b22",shellBd:"#21262d",sidebarBg:"#161b22",sidebarBd:"#21262d",surfHigh:"#1c2128",surfMid:"#161b22",surfLow:"#0d1117",hoverBg:"#21262d",inputBg:"#0d1117",inputBd:"#30363d",dropBg:"#161b22",divider:"#21262d",tblHead:"#161b22",tblEven:"#1c2128",tblOdd:"#161b22",statusBg:"#0d1117",badgeBg:"#21262d",badgeTx:"#7d8590",textA:"#e6edf3",textB:"#8b949e",textC:"#6e7681",textD:"#484f58",scrollThumb:"#30363d",shadow:"0 4px 24px rgba(0,0,0,.6)"},
  warm:     {id:"warm",     lbl:"ğŸŒ…", name:"Warm Ivory", bg:"#f0ebe0",shellBg:"#fdf8f0",shellBd:"#e4d8c4",sidebarBg:"#fdf8f0",sidebarBd:"#e4d8c4",surfHigh:"#fdfaf4",surfMid:"#f5f0e8",surfLow:"#ede5d4",hoverBg:"#e8dece",inputBg:"#fdfaf4",inputBd:"#d4c8b0",dropBg:"#fdfaf4",divider:"#ddd0b8",tblHead:"#f0ebe0",tblEven:"#fdfaf4",tblOdd:"#f5f0e8",statusBg:"#ede5d4",badgeBg:"#e4d8c4",badgeTx:"#4a3c28",textA:"#1c1409",textB:"#5a4a34",textC:"#8a7460",textD:"#b0a090",scrollThumb:"#c8b89c",shadow:"0 4px 16px rgba(60,40,10,.12)"},
  slate:    {id:"slate",    lbl:"ğŸ”·", name:"Slate",      bg:"#1a2030",shellBg:"#252d40",shellBd:"#2d3654",sidebarBg:"#1e2433",sidebarBd:"#2d3654",surfHigh:"#2a3450",surfMid:"#222a3e",surfLow:"#1a2030",hoverBg:"#2d3654",inputBg:"#1a2030",inputBd:"#2d3654",dropBg:"#222a3e",divider:"#2d3654",tblHead:"#1e2433",tblEven:"#222a3e",tblOdd:"#1e2433",statusBg:"#1a2030",badgeBg:"#2d3654",badgeTx:"#8895b0",textA:"#d8e0f0",textB:"#8895b0",textC:"#5a6680",textD:"#3a4460",scrollThumb:"#2d3654",shadow:"0 4px 24px rgba(0,0,0,.5)"}
};
var ACCENTS = {
  orange:{id:"orange",lbl:"Oracle Orange",a:"#E8690A",al:"rgba(232,105,10,.1)",ad:"#b85208",tx:"#fff"},
  blue:  {id:"blue",  lbl:"Azure Blue",   a:"#0078D4",al:"rgba(0,120,212,.1)", ad:"#005a9e",tx:"#fff"},
  teal:  {id:"teal",  lbl:"Deep Teal",    a:"#007C7C",al:"rgba(0,124,124,.1)", ad:"#005f5f",tx:"#fff"},
  green: {id:"green", lbl:"Emerald",      a:"#15803D",al:"rgba(21,128,61,.1)", ad:"#0f6330",tx:"#fff"},
  purple:{id:"purple",lbl:"Violet",       a:"#7C3AED",al:"rgba(124,58,237,.1)",ad:"#5b21b6",tx:"#fff"},
  rose:  {id:"rose",  lbl:"Rose Red",     a:"#BE123C",al:"rgba(190,18,60,.1)", ad:"#9b0d30",tx:"#fff"}
};

// â”€â”€â”€ FONT CATALOGUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var UI_FONTS = [
  {id:"nunito",   name:"Nunito Sans",       family:"'Nunito Sans', sans-serif",      tag:"DEFAULT Â· Warm & Rounded"},
  {id:"inter",    name:"Inter",             family:"'Inter', sans-serif",            tag:"Clean Â· Neutral"},
  {id:"dm",       name:"DM Sans",           family:"'DM Sans', sans-serif",          tag:"Modern Â· Geometric"},
  {id:"jakarta",  name:"Plus Jakarta Sans", family:"'Plus Jakarta Sans', sans-serif",tag:"Professional Â· Crisp"},
  {id:"outfit",   name:"Outfit",            family:"'Outfit', sans-serif",           tag:"Minimal Â· Contemporary"},
  {id:"source",   name:"Source Sans 3",     family:"'Source Sans 3', sans-serif",    tag:"Editorial Â· Readable"}
];
var DATA_FONTS = [
  {id:"ibmplex",  name:"IBM Plex Mono",   family:"'IBM Plex Mono', monospace",  tag:"DEFAULT Â· Technical"},
  {id:"jetbrains",name:"JetBrains Mono",  family:"'JetBrains Mono', monospace", tag:"Dev-Friendly Â· Sharp"},
  {id:"fira",     name:"Fira Code",       family:"'Fira Code', monospace",      tag:"Ligatures Â· Elegant"},
  {id:"roboto",   name:"Roboto Mono",     family:"'Roboto Mono', monospace",    tag:"Neutral Â· Clean"},
  {id:"space",    name:"Space Mono",      family:"'Space Mono', monospace",     tag:"Distinctive Â· Retro"}
];
function uiFF(id) { return (UI_FONTS.find(function(f){return f.id===id})||UI_FONTS[0]).family; }
function dataFF(id){ return (DATA_FONTS.find(function(f){return f.id===id})||DATA_FONTS[0]).family; }

// â”€â”€â”€ DEFAULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var DEFAULTS = {
  mode:"light", accent:"orange",
  density:"comfortable", fontSize:"medium",
  tblStyle:"striped", lineView:"table",
  sbWidth:340, showStatusBar:true,
  showThumbs:true, showRowNums:true,
  showCatBadge:true, compactSide:false,
  uiFont:"nunito", dataFont:"ibmplex"
};
var FS_MAP = {small:11,medium:13,large:15};
var PY_MAP = {compact:4,comfortable:7,spacious:12};

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ROLE_C = {Admin:"#BE123C",Manager:"#1D4ED8",Supervisor:"#7C3AED",Operator:"#15803D","View Only":"#6b7280"};
var ROLE_K = {Admin:"ADMIN",Manager:"MGR",Supervisor:"SUP",Operator:"OPR","View Only":"VIEW"};
var NOTIF_C = {action:"#ef4444",warning:"#f59e0b",info:"#0078D4",system:"#6b7280"};
var NOTIF_BG = {action:"rgba(239,68,68,.08)",warning:"rgba(245,158,11,.08)",info:"rgba(0,120,212,.08)",system:"rgba(107,114,128,.06)"};

// â”€â”€â”€ MODULE DEFINITIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var MODS = [
  {id:"procurement",icon:"ğŸ“¦",lbl:"Procurement", badge:3, desc:"PO Â· GRN Â· Returns",       col:"#E8690A",stats:{pend:3,today:12,val:"â‚¹4.2L"}},
  {id:"production", icon:"ğŸ­",lbl:"Production",  badge:1, desc:"Work Orders Â· BOM Â· JW",   col:"#0078D4",stats:{pend:1,today:5, val:"8 WOs"}},
  {id:"inventory",  icon:"ğŸ—„ï¸",lbl:"Inventory",   badge:0, desc:"Stock Â· Transfer Â· Alerts", col:"#007C7C",stats:{pend:0,today:8, val:"142 SKUs"}},
  {id:"quality",    icon:"ğŸ”¬",lbl:"Quality",      badge:2, desc:"Fabric Â· Inline Â· AQL",     col:"#7C3AED",stats:{pend:2,today:6, val:"94.2%"}},
  {id:"sales",      icon:"ğŸ’¼",lbl:"Sales",        badge:0, desc:"Orders Â· DC Â· Invoice",     col:"#15803D",stats:{pend:0,today:3, val:"â‚¹8.7L"}},
  {id:"finance",    icon:"ğŸ’°",lbl:"Finance",      badge:4, desc:"Payments Â· GST Â· Reports",  col:"#BE123C",stats:{pend:4,today:9, val:"â‚¹2.1L"}},
  {id:"masters",    icon:"ğŸ—‚ï¸",lbl:"Masters",      badge:0, desc:"Items Â· Suppliers Â· Setup", col:"#B45309",stats:{pend:0,today:0, val:"52 sheets"}},
  {id:"dashboard",  icon:"ğŸ“ˆ",lbl:"Dashboard",    badge:0, desc:"Reports Â· Analytics",      col:"#0E7490",stats:{pend:0,today:0, val:"Live"}}
];

// â”€â”€â”€ ACTIVITY (used on dashboard) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ACTIVITY = [
  {icon:"ğŸ“¦",text:"PO-2026-0042 submitted to Coats India",  sub:"Rajesh Kumar Â· 14:08", col:"#E8690A"},
  {icon:"ğŸ”¬",text:"Fabric QC failed â€” Lot LOT-089",         sub:"Priya Sharma Â· 13:45", col:"#BE123C"},
  {icon:"ğŸ­",text:"Work Order WO-0089 started",             sub:"Amit Singh Â· 13:30",   col:"#0078D4"},
  {icon:"ğŸ—„ï¸",text:"Stock transfer ST-0034 approved",       sub:"Ravi Verma Â· 12:55",   col:"#007C7C"},
  {icon:"ğŸ’°",text:"Payment â‚¹45,000 approved",               sub:"Saurav Â· 12:00",       col:"#15803D"}
];

// â”€â”€â”€ CMD PALETTE INDEX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CMD_INDEX = [];
function buildCmdIndex() {
  CMD_INDEX = [];
  MODS.forEach(function(m) {
    CMD_INDEX.push({icon:m.icon,label:m.lbl,sub:m.desc,group:"Modules",id:m.id,type:"module"});
  });
  var actions = [
    {icon:"â•",label:"New Purchase Order",    sub:"Procurement â†’ PO", group:"Quick Actions",id:"new-po",  type:"action"},
    {icon:"â•",label:"New Work Order",         sub:"Production â†’ WO",  group:"Quick Actions",id:"new-wo",  type:"action"},
    {icon:"â•",label:"New GRN",               sub:"Procurement â†’ GRN",group:"Quick Actions",id:"new-grn", type:"action"},
    {icon:"â•",label:"New Fabric Inspection", sub:"Quality â†’ Fabric", group:"Quick Actions",id:"new-qc",  type:"action"},
    {icon:"ğŸ”",label:"Search Suppliers",      sub:"Masters â†’ Supplier",group:"Quick Actions",id:"sup-srch",type:"action"},
    {icon:"ğŸ”",label:"Search Items",          sub:"Masters â†’ Items",  group:"Quick Actions",id:"itm-srch",type:"action"}
  ];
  var records = [
    {icon:"ğŸ§¾",label:"PO-2026-0042",sub:"Coats India Â· â‚¹1,24,500 Â· Pending",    group:"Recent Records",id:"rec1",type:"record"},
    {icon:"ğŸ”§",label:"WO-0089",     sub:"5249HP Â· 240 pcs Â· Completed",          group:"Recent Records",id:"rec2",type:"record"},
    {icon:"ğŸ§ª",label:"QC-0012",     sub:"LOT-089 Â· Fabric Â· Failed",             group:"Recent Records",id:"rec3",type:"record"},
    {icon:"ğŸ“‹",label:"STK-0034",    sub:"RM-FAB-007 Â· Transfer Â· Approved",      group:"Recent Records",id:"rec4",type:"record"}
  ];
  var settings = [
    {icon:"âš™ï¸",label:"Open Settings",         sub:"Workspace preferences",group:"Settings",id:"open-cfg",  type:"setting"},
    {icon:"ğŸ©¶",label:"Switch to Light Grey",  sub:"Theme Â· Light Grey",   group:"Settings",id:"mode-lg",   type:"setting"},
    {icon:"ğŸŒ™",label:"Switch to Midnight",    sub:"Theme Â· Midnight",     group:"Settings",id:"mode-mid",  type:"setting"},
    {icon:"ğŸ”·",label:"Switch to Slate",       sub:"Theme Â· Slate",        group:"Settings",id:"mode-slate",type:"setting"}
  ];
  CMD_INDEX = CMD_INDEX.concat(actions, records, settings);
}

// â”€â”€â”€ GLOBAL STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var APP = {
  user: null, modules: [], lists: {}, lookups: {},
  preferences: {},
  activeModule: 'dashboard', activePage: 'dashboard',
  cfg: JSON.parse(JSON.stringify(DEFAULTS)),
  settingsDraft: null,
  notifications: [],
  shortcuts: [],
  onlineUsers: [],
  poList: [], grnList: [], currentPO: null, currentGRN: null,
  unsavedChanges: false, heartbeatInterval: null,
  notifOpen: false, cmdOpen: false, cfgOpen: false,
  showAllUsers: false, editSC: false,
  cmdSel: 0, cmdQuery: "",
  sidebarDrag: false, sidebarWidth: 340,
  clockInterval: null
};

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id) { return document.getElementById(id); }
function aColor(e) {
  var P = ["#E8690A","#0078D4","#007C7C","#15803D","#7C3AED","#BE123C","#B45309","#0E7490","#6D28D9","#047857","#C2410C","#1D4ED8"];
  var h = 0;
  for (var i = 0; i < e.length; i++) h = e.charCodeAt(i) + ((h << 5) - h);
  return P[Math.abs(h) % P.length];
}
function ini(n) {
  var p = n.trim().split(" ");
  return (p[0][0] + (p[1] ? p[1][0] : (p[0][1] || ""))).toUpperCase();
}
function ago(ts) {
  var s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return s + "s";
  if (s < 3600) return Math.floor(s / 60) + "m";
  if (s < 86400) return Math.floor(s / 3600) + "h";
  return Math.floor(s / 86400) + "d";
}
function greet() {
  var h = new Date().getHours();
  return h < 12 ? "Good morning" : h < 17 ? "Good afternoon" : "Good evening";
}
function todayStr() {
  return new Date().toLocaleDateString("en-IN", {weekday:"long",day:"numeric",month:"long",year:"numeric"});
}
function timeStr() {
  return new Date().toLocaleTimeString("en-IN", {hour:"2-digit",minute:"2-digit"});
}
function fuzzy(q, s) { return !q || s.toLowerCase().indexOf(q.toLowerCase()) >= 0; }
function M() { return MODES[APP.cfg.mode]; }
function A() { return ACCENTS[APP.cfg.accent]; }
function fz() { return FS_MAP[APP.cfg.fontSize]; }

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  var c = $('toastContainer');
  var t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(function() { t.remove(); }, 3000);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initApp() {
  google.script.run
    .withSuccessHandler(onBootstrapSuccess)
    .withFailureHandler(onBootstrapError)
    .getUIBootstrap();
}

function onBootstrapSuccess(data) {
  APP.user = data.user;
  APP.modules = data.modules || MODS;
  APP.lists = data.lists || {};
  APP.lookups = data.lookups || {};
  APP.preferences = data.preferences || {};

  // Apply saved theme
  if (data.preferences && data.preferences.theme) {
    APP.cfg.mode = data.preferences.theme.mode || 'light';
    APP.cfg.accent = data.preferences.theme.accent || 'orange';
  }

  // Apply saved shortcuts
  if (data.preferences && data.preferences.shortcuts) {
    APP.shortcuts = data.preferences.shortcuts;
  } else {
    // Default shortcuts
    APP.shortcuts = [
      {id:"sc1",icon:"ğŸ“¦",label:"New PO",        mod:"procurement",sub:"Procurement"},
      {id:"sc2",icon:"ğŸ­",label:"WO-0089",       mod:"production", sub:"Production"},
      {id:"sc3",icon:"ğŸ­",label:"Coats India",   mod:"masters",    sub:"Supplier"},
      {id:"sc4",icon:"ğŸ”¬",label:"Pending QC",    mod:"quality",    sub:"Quality"}
    ];
  }

  buildCmdIndex();
  applyTheme();
  renderShellBar();
  renderSidebar();
  navigateTo('dashboard');
  updateClock();
  APP.clockInterval = setInterval(updateClock, 60000);

  // Heartbeat
  sendHeartbeat();
  APP.heartbeatInterval = setInterval(sendHeartbeat, 30000);

  // Load notifications
  loadNotifications();

  // Load online users
  loadOnlineUsers();

  // Keyboard shortcuts
  document.addEventListener('keydown', handleGlobalKey);
}

function onBootstrapError(err) {
  $('contentArea').innerHTML =
    '<div style="text-align:center;padding:40px;">' +
    '<h3 style="color:#ef4444;">Failed to load ERP</h3>' +
    '<p style="color:var(--text-c);margin-top:8px;">' + (err.message || 'Unknown error') + '</p>' +
    '<button onclick="initApp()" style="margin-top:16px;padding:8px 20px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-weight:700;">Retry</button>' +
    '</div>';
}

// â”€â”€â”€ THEME SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme() {
  var b = document.body;
  // Remove old mode/accent classes
  b.className = b.className.replace(/mode-\S+/g, '').replace(/accent-\S+/g, '').trim();
  b.classList.add('mode-' + APP.cfg.mode, 'accent-' + APP.cfg.accent);

  // Apply font family
  document.documentElement.style.setProperty('--ff-ui', uiFF(APP.cfg.uiFont));
  document.documentElement.style.setProperty('--ff-data', dataFF(APP.cfg.dataFont));
  document.documentElement.style.setProperty('--fz', fz() + 'px');
  document.documentElement.style.setProperty('--py', PY_MAP[APP.cfg.density] + 'px');

  // Scrollbar colour
  var scr = document.getElementById('_scrollStyle');
  if (!scr) { scr = document.createElement('style'); scr.id = '_scrollStyle'; document.head.appendChild(scr); }
  scr.textContent = '::-webkit-scrollbar-thumb{background:' + M().scrollThumb + '}';

  // Theme animation
  var root = $('appRoot');
  if (root) { root.classList.remove('theme-anim'); void root.offsetWidth; root.classList.add('theme-anim'); }

  // Update shell bar theme/accent buttons
  renderThemeBar();
  renderAccentBar();
}

function applyThemeMode(mode) {
  APP.cfg.mode = mode;
  applyTheme();
  saveThemeToServer();
}

function applyAccent(accent) {
  APP.cfg.accent = accent;
  applyTheme();
  saveThemeToServer();
}

function saveThemeToServer() {
  try {
    google.script.run.saveUserTheme({mode: APP.cfg.mode, accent: APP.cfg.accent});
  } catch(e) {}
}

// â”€â”€â”€ RENDER THEME BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderThemeBar() {
  var bar = $('themeBar');
  if (!bar) return;
  bar.innerHTML = '';
  Object.keys(MODES).forEach(function(key) {
    var m = MODES[key];
    var btn = document.createElement('button');
    btn.className = 'theme-btn' + (APP.cfg.mode === key ? ' active' : '');
    btn.title = m.name;
    btn.textContent = m.lbl;
    btn.onclick = function() { applyThemeMode(key); };
    bar.appendChild(btn);
  });
}

function renderAccentBar() {
  var bar = $('accentBar');
  if (!bar) return;
  bar.innerHTML = '';
  Object.keys(ACCENTS).forEach(function(key) {
    var ac = ACCENTS[key];
    var dot = document.createElement('button');
    dot.className = 'accent-dot' + (APP.cfg.accent === key ? ' active' : '');
    dot.title = ac.lbl;
    dot.style.background = ac.a;
    dot.onclick = function() { applyAccent(key); };
    bar.appendChild(dot);
  });
}

// â”€â”€â”€ RENDER SHELL BAR AVATARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShellAvatars() {
  var container = $('shellAvatars');
  if (!container) return;
  container.innerHTML = '';

  var me = APP.user || {name:"User",email:"user@cc.com",role:"Admin"};
  var users = APP.onlineUsers || [];
  var vis = users.slice(0, 3);
  var ovfl = users.length - 3;
  var total = users.length + 1;

  // Self avatar
  var selfAv = document.createElement('div');
  selfAv.className = 'avatar self';
  selfAv.style.background = A().a;
  selfAv.textContent = ini(me.name);
  selfAv.title = me.name + ' (You)';
  container.appendChild(selfAv);

  // Other avatars
  vis.forEach(function(u) {
    var av = document.createElement('div');
    av.className = 'avatar';
    av.style.background = aColor(u.email || u.name);
    av.textContent = ini(u.name);
    av.title = u.name;
    var dot = document.createElement('div');
    dot.className = 'status-dot';
    dot.style.background = u.status === 'active' ? '#22c55e' : '#f59e0b';
    av.appendChild(dot);
    container.appendChild(av);
  });

  // Overflow
  if (ovfl > 0) {
    var btn = document.createElement('button');
    btn.className = 'overflow-btn';
    btn.textContent = '+' + ovfl;
    btn.onclick = function(e) {
      e.stopPropagation();
      toggleAllUsersDropdown();
    };
    container.appendChild(btn);
  }

  // Online pill
  var pill = document.createElement('div');
  pill.className = 'online-pill';
  pill.innerHTML = '<div class="dot"></div>' + total + ' online';
  container.appendChild(pill);
}

function toggleAllUsersDropdown() {
  // Simple implementation - could enhance with dropdown
  APP.showAllUsers = !APP.showAllUsers;
}

// â”€â”€â”€ RENDER SHELL BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShellBar() {
  renderThemeBar();
  renderAccentBar();
  renderShellAvatars();
  updateNotifBadge();
}

// â”€â”€â”€ RENDER SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSidebar() {
  var sidebar = $('sidebar');
  if (!sidebar) return;

  // Width
  sidebar.style.width = APP.cfg.compactSide ? '46px' : APP.cfg.sbWidth + 'px';
  sidebar.style.transition = APP.sidebarDrag ? 'none' : 'width .2s ease';

  // Label
  var label = $('sidebarLabel');
  if (APP.cfg.compactSide) {
    label.style.display = 'none';
  } else {
    label.style.display = '';
    $('sidebarWidthLabel').textContent = APP.cfg.sbWidth;
  }

  // Quick Access
  var qaSection = $('quickAccessSection');
  qaSection.style.display = APP.cfg.compactSide ? 'none' : '';
  renderQuickAccess();

  // Modules label
  var modLabel = $('modulesLabel');
  modLabel.style.display = APP.cfg.compactSide ? 'none' : '';

  // Module nav
  renderModuleNav();

  // Extra nav
  renderExtraNav();

  // User card
  renderSidebarUser();

  // Drag handle
  var dh = $('dragHandle');
  dh.style.display = APP.cfg.compactSide ? 'none' : '';
}

function renderQuickAccess() {
  var list = $('quickAccessList');
  list.innerHTML = '';
  if (APP.shortcuts.length === 0) {
    list.innerHTML = '<div class="qa-empty">No shortcuts yet.<br><span style="color:var(--accent);cursor:pointer;font-weight:700;" onclick="openCommandPalette()">Open Ctrl+K to pin items â­</span></div>';
    return;
  }
  APP.shortcuts.forEach(function(sc) {
    var item = document.createElement('div');
    item.className = 'qa-item';
    item.onclick = function() {
      var mod = MODS.find(function(m) { return m.id === sc.mod; });
      if (mod) navigateTo(mod.id);
    };
    var html = '<span class="icon">' + sc.icon + '</span>' +
      '<div style="flex:1;overflow:hidden;">' +
        '<div class="label">' + sc.label + '</div>' +
        '<div class="sub">' + sc.sub + '</div>' +
      '</div>';
    if (APP.editSC) {
      html += '<button onclick="event.stopPropagation();removeShortcut(\'' + sc.id + '\')" style="width:18px;height:18px;border-radius:50%;background:#ef4444;color:#fff;border:none;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">Ã—</button>';
    }
    item.innerHTML = html;
    list.appendChild(item);
  });
}

function toggleQAEdit() {
  APP.editSC = !APP.editSC;
  $('qaEditBtn').textContent = APP.editSC ? 'Done' : 'Edit';
  $('qaEditBtn').style.background = APP.editSC ? A().al : 'none';
  $('qaEditBtn').style.border = APP.editSC ? '1px solid ' + A().a : 'none';
  $('qaEditBtn').style.color = APP.editSC ? A().a : '';
  renderQuickAccess();
}

function removeShortcut(id) {
  APP.shortcuts = APP.shortcuts.filter(function(s) { return s.id !== id; });
  renderQuickAccess();
  try { google.script.run.removeShortcut(id); } catch(e) {}
}

function renderModuleNav() {
  var nav = $('moduleNav');
  nav.innerHTML = '';
  MODS.forEach(function(mod) {
    var active = APP.activeModule === mod.id;
    var btn = document.createElement('button');
    btn.className = 'nav-btn' + (active ? ' active' : '');
    if (APP.cfg.compactSide) {
      btn.style.padding = '9px 0';
      btn.style.justifyContent = 'center';
      btn.style.gap = '0';
    }
    var html = '<span class="icon">' + mod.icon + '</span>';
    if (!APP.cfg.compactSide) {
      html += '<span class="lbl">' + mod.lbl + '</span>';
      if (mod.badge > 0) {
        html += '<span class="badge-count">' + mod.badge + '</span>';
      }
    }
    btn.innerHTML = html;
    btn.onclick = function() { navigateTo(mod.id); };
    nav.appendChild(btn);
  });
}

function renderExtraNav() {
  var nav = $('extraNav');
  nav.innerHTML = '';
  var items = [
    {icon:"âš™ï¸", lbl:"Settings", fn:function(){ toggleSettingsPanel(); }, active: APP.cfgOpen},
    {icon:"ğŸ‘¥", lbl:"Users",    fn:function(){}, active:false}
  ];
  items.forEach(function(x) {
    var btn = document.createElement('button');
    btn.className = 'nav-btn' + (x.active ? ' active' : '');
    if (APP.cfg.compactSide) {
      btn.style.padding = '9px 0';
      btn.style.justifyContent = 'center';
      btn.style.gap = '0';
    }
    var html = '<span class="icon">' + x.icon + '</span>';
    if (!APP.cfg.compactSide) {
      html += '<span class="lbl" style="color:var(--text-c);">' + x.lbl + '</span>';
    }
    btn.innerHTML = html;
    btn.onclick = x.fn;
    nav.appendChild(btn);
  });
}

function renderSidebarUser() {
  var el = $('sidebarUser');
  if (!el) return;
  el.style.display = APP.cfg.compactSide ? 'none' : '';
  var me = APP.user || {name:"User",email:"user@cc.com",role:"Admin"};
  var roleColor = ROLE_C[me.role] || '#6b7280';
  var roleKey = ROLE_K[me.role] || 'USER';
  el.innerHTML =
    '<div class="avatar-sm">' + ini(me.name) + '</div>' +
    '<div class="info">' +
      '<div class="name">' + me.name + '</div>' +
      '<span class="role-badge" style="background:' + roleColor + '22;color:' + roleColor + ';">' + roleKey + '</span>' +
    '</div>';
}

function toggleCompactSidebar(compact) {
  APP.cfg.compactSide = compact;
  renderSidebar();
}

// â”€â”€â”€ SIDEBAR DRAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  var handle = null;
  document.addEventListener('DOMContentLoaded', function() {
    handle = $('dragHandle');
    if (!handle) return;
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      APP.sidebarDrag = true;
      handle.classList.add('dragging');
      var x0 = e.clientX, w0 = APP.cfg.sbWidth;
      function mv(ev) {
        APP.cfg.sbWidth = Math.max(200, Math.min(520, w0 + (ev.clientX - x0)));
        $('sidebar').style.width = APP.cfg.sbWidth + 'px';
        $('sidebar').style.transition = 'none';
        $('sidebarWidthLabel').textContent = APP.cfg.sbWidth;
      }
      function up() {
        APP.sidebarDrag = false;
        handle.classList.remove('dragging');
        $('sidebar').style.transition = 'width .2s ease';
        window.removeEventListener('mousemove', mv);
        window.removeEventListener('mouseup', up);
      }
      window.addEventListener('mousemove', mv);
      window.addEventListener('mouseup', up);
    });
  });
})();

// â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigateTo(moduleId) {
  APP.activeModule = moduleId;
  renderModuleNav();
  updateBreadcrumb();
  updateSubToolbar();

  if (moduleId === 'dashboard') {
    renderDashboard();
  } else if (moduleId === 'procurement') {
    renderProcurementList();
  } else {
    renderModulePlaceholder(moduleId);
  }

  // Send heartbeat with current module
  try {
    google.script.run.heartbeat(moduleId, 'Home');
  } catch(e) {}
}

function updateBreadcrumb() {
  var bc = $('breadcrumb');
  bc.innerHTML = '<a onclick="navigateTo(\'dashboard\')">Home</a>';
  if (APP.activeModule !== 'dashboard') {
    var mod = MODS.find(function(m) { return m.id === APP.activeModule; });
    if (mod) {
      bc.innerHTML += '<span class="sep">â€º</span><span class="crumb" style="color:' + A().a + ';font-weight:700;">' + mod.lbl + '</span>';
    }
  }
}

function updateSubToolbar() {
  var tb = $('subToolbar');
  if (APP.activeModule === 'dashboard') {
    tb.innerHTML =
      '<span class="title">ğŸ  Home â€” Module Overview</span>' +
      '<div class="shell-spacer"></div>' +
      '<span class="time" id="clockDisplay">' + timeStr() + '</span>' +
      '<button class="tool-btn">ğŸ–¨ï¸ Print</button>' +
      '<button class="tool-btn">ğŸ“¤ Export â–¾</button>';
  } else {
    var mod = MODS.find(function(m) { return m.id === APP.activeModule; });
    if (mod) {
      tb.innerHTML =
        '<span class="title">' + mod.icon + ' ' + mod.lbl + '</span>' +
        '<div class="shell-spacer"></div>' +
        '<span class="time">' + timeStr() + '</span>';
    }
  }
}

function updateClock() {
  var t = timeStr();
  var el = $('clockDisplay');
  if (el) el.textContent = t;
  var sc = $('statusClock');
  if (sc) sc.textContent = t;
  var sr = $('statusRight');
  if (sr) {
    sr.textContent = 'CC ERP Â· ' + (APP.activeModule === 'dashboard' ? 'Home' : MODS.find(function(m){return m.id===APP.activeModule})?.lbl || 'Home') +
      ' Â· ' + M().name + ' Â· ' + A().lbl;
  }
}

// â”€â”€â”€ RENDER DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  var content = $('contentArea');
  var me = APP.user || {name:"User",email:"user@cc.com",role:"Admin"};
  var users = APP.onlineUsers || [];
  var totalOnline = users.length + 1;
  var _fz = fz();

  var html = '';

  // Greeting
  html += '<div class="greeting fade-slide" style="margin-bottom:20px;">';
  html += '<h2>' + greet() + ', ' + me.name.split(' ')[0] + ' ğŸ‘‹</h2>';
  html += '<p>' + todayStr() + '</p>';
  html += '</div>';

  // Quick Stats
  var stats = [
    {lbl:"Open POs",  val:"3",     sub:"â‚¹4.2L value",   col:"#E8690A",icon:"ğŸ“¦"},
    {lbl:"Active WOs",val:"5",     sub:"8 on floor",    col:"#0078D4",icon:"ğŸ­"},
    {lbl:"Pending QC",val:"2",     sub:"Lot 089 failed",col:"#7C3AED",icon:"ğŸ”¬"},
    {lbl:"Due Pmts",  val:"â‚¹2.1L", sub:"4 invoices",    col:"#BE123C",icon:"ğŸ’°"}
  ];
  html += '<div class="stats-grid">';
  stats.forEach(function(s) {
    html += '<div class="stat-card" style="border-left:3px solid ' + s.col + ';">';
    html += '<div class="head"><span class="icon">' + s.icon + '</span><span class="lbl">' + s.lbl + '</span></div>';
    html += '<div class="val">' + s.val + '</div>';
    html += '<div class="sub">' + s.sub + '</div>';
    html += '</div>';
  });
  html += '</div>';

  // Modules section label
  html += '<div class="section-label">Modules</div>';

  // Module tiles
  html += '<div class="tiles-grid">';
  MODS.forEach(function(mod) {
    html += '<div class="module-tile" style="--tile-col:' + mod.col + ';" onclick="navigateTo(\'' + mod.id + '\')" onmouseenter="this.classList.add(\'hover\')" onmouseleave="this.classList.remove(\'hover\')">';
    html += '<div class="top-bar" style="background:transparent;"></div>';
    if (mod.badge > 0) {
      html += '<div class="badge-float">' + mod.badge + '</div>';
    }
    html += '<div class="icon">' + mod.icon + '</div>';
    html += '<div class="name">' + mod.lbl + '</div>';
    html += '<div class="desc">' + mod.desc + '</div>';
    html += '<div class="foot">';
    if (mod.stats.pend > 0) {
      html += '<div class="col"><span class="k">Pending</span><span class="v" style="font-size:13px;font-weight:900;color:#ef4444;">' + mod.stats.pend + '</span></div>';
    }
    html += '<div class="col"><span class="k">Today</span><span class="v">' + mod.stats.today + '</span></div>';
    html += '<div class="col right"><span class="k">Value</span><span class="v">' + mod.stats.val + '</span></div>';
    html += '</div></div>';
  });
  html += '</div>';

  // Bottom row
  html += '<div class="bottom-grid">';

  // Activity feed
  html += '<div class="activity-box">';
  html += '<div class="header"><span class="title">ğŸ• Recent Activity</span><span class="sub">Today</span></div>';
  ACTIVITY.forEach(function(a, i) {
    var rowBg = i % 2 === 0 ? 'var(--tbl-even)' : 'var(--tbl-odd)';
    html += '<div class="activity-item" style="border-left:3px solid ' + a.col + ';background:' + rowBg + ';">';
    html += '<span class="icon">' + a.icon + '</span>';
    html += '<div><div class="text">' + a.text + '</div><div class="meta">' + a.sub + '</div></div>';
    html += '</div>';
  });
  html += '</div>';

  // Online users
  html += '<div class="online-box">';
  html += '<div class="header"><span class="title">ğŸ‘¥ Online Now</span>';
  html += '<div class="online-pill"><div class="dot"></div>' + totalOnline + '</div>';
  html += '</div>';

  // Self
  html += renderOnlineUserRow(me, true);
  // Others
  users.forEach(function(u) {
    html += renderOnlineUserRow(u, false);
  });
  html += '</div>';

  html += '</div>'; // bottom-grid

  content.innerHTML = html;

  // Update status bar
  updateStatusBar(totalOnline);
}

function renderOnlineUserRow(u, isSelf) {
  var dot = (u.status === 'active' || isSelf) ? '#22c55e' : '#f59e0b';
  var bgColor = isSelf ? A().a : aColor(u.email || u.name);
  var roleColor = ROLE_C[u.role] || '#6b7280';
  var roleKey = ROLE_K[u.role] || 'USER';
  var html = '<div class="online-user">';
  html += '<div class="av">';
  html += '<div class="circle" style="background:' + bgColor + ';">' + ini(u.name) + '</div>';
  html += '<div class="dot" style="background:' + dot + ';"></div>';
  html += '</div>';
  html += '<div class="info">';
  html += '<div class="name">' + u.name.split(' ')[0];
  if (isSelf) html += ' <span class="you-badge">YOU</span>';
  html += '</div>';
  html += '<div class="mod">' + (u.module || 'Dashboard') + '</div>';
  html += '</div>';
  html += '<span class="role" style="background:' + roleColor + '22;color:' + roleColor + ';">' + roleKey + '</span>';
  html += '</div>';
  return html;
}

function updateStatusBar(totalOnline) {
  var el = $('statOnline');
  if (el) el.textContent = totalOnline || 1;
  var unread = APP.notifications.filter(function(n) { return !n.read; }).length;
  var pending = $('statPending');
  if (pending) pending.textContent = unread + 9;
}

// â”€â”€â”€ MODULE PLACEHOLDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderModulePlaceholder(moduleId) {
  var mod = MODS.find(function(m) { return m.id === moduleId; });
  if (!mod) return;
  var content = $('contentArea');
  content.innerHTML =
    '<div style="text-align:center;padding:60px 20px;">' +
    '<div style="font-size:48px;margin-bottom:16px;">' + mod.icon + '</div>' +
    '<h2 style="font-size:22px;font-weight:900;color:var(--text-a);margin-bottom:8px;">' + mod.lbl + '</h2>' +
    '<p style="color:var(--text-c);margin-bottom:4px;">' + mod.desc + '</p>' +
    '<p style="color:var(--text-d);font-size:12px;margin-top:16px;">This module is connected to your Google Sheet.<br>Data will load from the configured sheet.</p>' +
    '<div style="margin-top:24px;display:flex;gap:12px;justify-content:center;">' +
    '<button onclick="navigateTo(\'dashboard\')" style="padding:8px 20px;border-radius:6px;border:1px solid var(--divider);background:var(--surf-mid);color:var(--text-b);cursor:pointer;font-weight:700;font-family:var(--ff-ui);">â† Back to Dashboard</button>' +
    '</div></div>';
}

// â”€â”€â”€ PROCUREMENT MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProcurementList() {
  var content = $('contentArea');
  content.style.padding = '0';

  // Try to load from server
  google.script.run
    .withSuccessHandler(function(data) {
      APP.poList = data || [];
      buildProcurementListHTML('PO');
    })
    .withFailureHandler(function() {
      // Use dummy data
      APP.poList = [
        {id:"PO-2026-0042",supplier:"SUP-001",supName:"Coats India Pvt Ltd",date:"24 Feb 2026",type:"Trim",items:3,base:112500,gst:13500,total:126000,status:"Pending"},
        {id:"PO-2026-0041",supplier:"SUP-004",supName:"Vardhman Textiles Ltd",date:"18 Feb 2026",type:"Fabric",items:5,base:287000,gst:34440,total:321440,status:"Approved"},
        {id:"PO-2026-0040",supplier:"SUP-002",supName:"YKK India Pvt Ltd",date:"15 Feb 2026",type:"Trim",items:2,base:45000,gst:8100,total:53100,status:"Approved"},
        {id:"PO-2026-0039",supplier:"SUP-003",supName:"Madura Fashion",date:"12 Feb 2026",type:"Fabric",items:4,base:198000,gst:23760,total:221760,status:"Received"},
        {id:"PO-2026-0038",supplier:"SUP-005",supName:"Alok Industries Ltd",date:"10 Feb 2026",type:"Fabric",items:3,base:155000,gst:18600,total:173600,status:"Draft"}
      ];
      buildProcurementListHTML('PO');
    })
    .getPOList();
}

function buildProcurementListHTML(sub) {
  var content = $('contentArea');
  var list = sub === 'PO' ? APP.poList : (APP.grnList || []);
  var STATUS_C = {Pending:"#f59e0b",Approved:"#22c55e",Received:"#0078D4",Draft:"#6b7280",Accepted:"#22c55e",Partial:"#f59e0b"};
  var statuses = [];
  list.forEach(function(r) { if (statuses.indexOf(r.status) < 0) statuses.push(r.status); });
  var fmtINR = function(v) { return 'â‚¹ ' + Number(v).toLocaleString('en-IN', {minimumFractionDigits:2}); };

  var html = '';
  // Sub toolbar
  html += '<div class="po-sub-toolbar">';
  html += '<div class="po-toggle-bar">';
  html += '<button class="po-toggle-btn ' + (sub==='PO'?'active':'') + '" onclick="buildProcurementListHTML(\'PO\')">Purchase Orders</button>';
  html += '<button class="po-toggle-btn ' + (sub==='GRN'?'active':'') + '" onclick="loadGRNList()">Goods Receipt</button>';
  html += '</div><div class="shell-spacer"></div>';
  html += '<div class="po-search-box"><span class="icon">ğŸ”</span><input placeholder="Search ' + sub + 'sâ€¦" oninput="filterPOList(this.value)"></div>';
  html += '<button class="po-new-btn" onclick="showToast(\'New ' + sub + ' form coming soon\')">+ New ' + sub + '</button>';
  html += '</div>';

  // Filter bar
  html += '<div class="filter-bar">';
  html += '<span class="filter-label">ğŸ”½ FILTER</span>';
  html += '<button class="filter-pill active" onclick="">All (' + list.length + ')</button>';
  statuses.forEach(function(st) {
    var cnt = list.filter(function(r) { return r.status === st; }).length;
    html += '<button class="filter-pill">' + st + ' (' + cnt + ')</button>';
  });
  html += '<div class="filter-sep"></div>';
  html += '<span class="filter-label">â†•ï¸ SORT</span>';
  html += '<span style="font-size:10px;color:var(--text-c);font-family:var(--ff-data);margin-left:auto;">' + list.length + ' records</span>';
  html += '</div>';

  // Table
  html += '<div style="flex:1;overflow:auto;">';
  html += '<table class="data-table"><thead><tr>';
  html += '<th style="width:40px;">#</th>';
  html += '<th>' + sub + ' No</th>';
  html += '<th>Supplier</th>';
  html += '<th>Date</th>';
  if (sub === 'PO') html += '<th>Type</th>';
  html += '<th style="text-align:center;">Items</th>';
  if (sub === 'PO') html += '<th style="text-align:right;">Total</th>';
  html += '<th style="text-align:center;">Status</th>';
  html += '</tr></thead><tbody>';

  list.forEach(function(r, i) {
    var rowBg = APP.cfg.tblStyle === 'striped' ? (i % 2 === 0 ? 'var(--tbl-even)' : 'var(--tbl-odd)') : 'var(--surf-high)';
    var sc = STATUS_C[r.status] || '#6b7280';
    html += '<tr style="background:' + rowBg + ';" onmouseenter="this.style.background=\'var(--hover-bg)\'" onmouseleave="this.style.background=\'' + rowBg + '\'">';
    html += '<td class="mono" style="color:var(--accent);font-weight:900;font-size:11px;">' + String(i+1).padStart(2,'0') + '</td>';
    html += '<td class="mono" style="font-weight:800;font-size:12px;">' + r.id + '</td>';
    html += '<td style="font-size:12px;color:var(--text-b);">' + (r.supName || '') + '</td>';
    html += '<td style="font-size:11px;color:var(--text-c);">' + (r.date || '') + '</td>';
    if (sub === 'PO') html += '<td><span style="font-size:9px;padding:2px 7px;border-radius:99px;background:var(--badge-bg);color:var(--text-b);font-weight:700;">' + (r.type || '') + '</span></td>';
    html += '<td class="mono" style="text-align:center;font-weight:700;color:var(--text-b);">' + (r.items || 0) + '</td>';
    if (sub === 'PO') html += '<td class="mono" style="text-align:right;font-weight:800;">' + fmtINR(r.total || 0) + '</td>';
    html += '<td style="text-align:center;"><span class="status-pill" style="background:' + sc + '18;color:' + sc + ';border:1px solid ' + sc + '40;">' + r.status + '</span></td>';
    html += '</tr>';
  });

  if (list.length === 0) {
    html += '<tr><td colspan="8" style="padding:60px;text-align:center;color:var(--text-d);font-size:13px;">No ' + sub + 's found.</td></tr>';
  }

  html += '</tbody></table></div>';

  content.innerHTML = html;
}

function loadGRNList() {
  google.script.run
    .withSuccessHandler(function(data) {
      APP.grnList = data || [];
      buildProcurementListHTML('GRN');
    })
    .withFailureHandler(function() {
      APP.grnList = [
        {id:"GRN-2026-0018",po:"PO-2026-0041",supplier:"SUP-004",supName:"Vardhman Textiles",date:"22 Feb 2026",items:5,recQty:520,accQty:510,status:"Accepted"},
        {id:"GRN-2026-0017",po:"PO-2026-0040",supplier:"SUP-002",supName:"YKK India",date:"20 Feb 2026",items:2,recQty:1000,accQty:985,status:"Partial"},
        {id:"GRN-2026-0016",po:"PO-2026-0039",supplier:"SUP-003",supName:"Madura Fashion",date:"18 Feb 2026",items:4,recQty:340,accQty:340,status:"Accepted"}
      ];
      buildProcurementListHTML('GRN');
    })
    .getGRNList();
}

function filterPOList(q) {
  // Simple client-side filter â€” could be improved
  if (!q) return;
}

// â”€â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadNotifications() {
  google.script.run
    .withSuccessHandler(function(data) {
      APP.notifications = (data || []).map(function(n) {
        n.ts = n.ts || Date.now();
        return n;
      });
      updateNotifBadge();
    })
    .withFailureHandler(function() {
      // Use dummy data
      APP.notifications = [
        {id:"NTF-00001",type:"action",icon:"ğŸ”´",title:"PO-2026-0042 awaiting approval",detail:"Rajesh Kumar submitted PO to Coats India â€” â‚¹1,24,500 for 8 items.",module:"Procurement",ref:"PO-2026-0042",ts:Date.now()-900000,actions:["approve","reject","reply"],read:false,status:"unread"},
        {id:"NTF-00002",type:"warning",icon:"ğŸŸ ",title:"RM-FAB-007 stock below reorder level",detail:"Current: 42 MTR Â· Reorder level: 100 MTR. Primary supplier: Vardhman Textiles.",module:"Inventory",ref:"RM-FAB-007",ts:Date.now()-7200000,actions:["view","reply"],read:false,status:"unread"},
        {id:"NTF-00003",type:"action",icon:"ğŸ”´",title:"Payment approval needed â€” â‚¹45,000",detail:"Invoice INV-0034 from Shree Enterprises. Due: 25-Feb-2026.",module:"Finance",ref:"INV-0034",ts:Date.now()-86400000,actions:["approve","reject","reply"],read:false,status:"unread"},
        {id:"NTF-00004",type:"info",icon:"ğŸ”µ",title:"Work Order WO-0089 completed",detail:"Amit Singh marked WO-0089 complete. 240 pcs.",module:"Production",ref:"WO-0089",ts:Date.now()-9000000,actions:["view","reply"],read:true,status:"read"},
        {id:"NTF-00005",type:"system",icon:"âšª",title:"Daily GAS cache refresh complete",detail:"PropertiesService refreshed all 46 FK relations at 07:00.",module:"System",ref:"",ts:Date.now()-28800000,actions:["dismiss"],read:true,status:"read"}
      ];
      updateNotifBadge();
    })
    .getNotifications({});
}

function updateNotifBadge() {
  var unread = APP.notifications.filter(function(n) { return !n.read; }).length;
  var badge = $('notifBadge');
  if (badge) {
    badge.textContent = unread;
    badge.style.display = unread > 0 ? 'flex' : 'none';
  }
  var btn = $('btnNotif');
  if (btn) {
    btn.className = 'shell-icon-btn' + (APP.notifOpen ? ' active' : '');
  }
}

function toggleNotifPanel() {
  APP.notifOpen = !APP.notifOpen;
  APP.cfgOpen = false;
  closeSettingsPanel();
  updateNotifBadge();
  if (APP.notifOpen) {
    renderNotifPanel();
  } else {
    $('notifPanelContainer').innerHTML = '';
  }
}

function renderNotifPanel() {
  var container = $('notifPanelContainer');
  var notifs = APP.notifications;
  var unread = notifs.filter(function(n) { return !n.read; }).length;

  var html = '<div class="notif-panel dd-anim">';

  // Header
  html += '<div class="notif-header">';
  html += '<div class="top">';
  html += '<div style="display:flex;align-items:center;gap:8px;">';
  html += '<span class="title">ğŸ”” Notifications</span>';
  if (unread > 0) html += '<div class="unread-badge">' + unread + '</div>';
  html += '</div>';
  html += '<div style="display:flex;gap:6px;align-items:center;">';
  if (unread > 0) html += '<button class="mark-all" onclick="markAllNotifRead()">Mark all read</button>';
  html += '<button class="close-btn" onclick="toggleNotifPanel()">Ã—</button>';
  html += '</div></div>';
  // Tabs
  html += '<div class="notif-tabs">';
  html += '<div class="notif-tab">All <span class="cnt">' + notifs.length + '</span></div>';
  html += '<div class="notif-tab">Unread <span class="cnt">' + unread + '</span></div>';
  html += '<div class="notif-tab">Action <span class="cnt">' + notifs.filter(function(n){return n.type==="action"}).length + '</span></div>';
  html += '</div></div>';

  // List
  html += '<div class="notif-list">';
  if (notifs.length === 0) {
    html += '<div style="padding:32px;text-align:center;color:var(--text-d);">';
    html += '<div style="font-size:32px;margin-bottom:8px;">ğŸ‰</div>';
    html += '<div style="font-size:12px;font-weight:700;">All caught up!</div>';
    html += '</div>';
  }
  notifs.forEach(function(n) {
    var tc = NOTIF_C[n.type] || '#6b7280';
    var tbg = NOTIF_BG[n.type] || 'transparent';
    var actioned = n.status === 'actioned';
    html += '<div class="notif-item" style="border-left:3px solid ' + (actioned ? 'var(--divider)' : tc) + ';background:' + (n.read ? 'var(--surf-high)' : tbg) + ';opacity:' + (actioned ? '.7' : '1') + ';">';
    html += '<div class="main" onclick="expandNotif(\'' + n.id + '\')">';
    html += '<div style="display:flex;align-items:flex-start;gap:9px;">';
    html += '<div class="type-dot" style="background:' + (actioned ? 'var(--text-d)' : tc) + ';"></div>';
    html += '<div style="flex:1;min-width:0;">';
    // Type label + time
    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">';
    html += '<span class="type-label" style="background:' + (actioned ? 'var(--badge-bg)' : tc+'20') + ';color:' + (actioned ? 'var(--text-d)' : tc) + ';">';
    html += actioned ? 'âœ“ DONE' : {action:"ACTION REQUIRED",warning:"WARNING",info:"INFO",system:"SYSTEM"}[n.type];
    html += '</span>';
    html += '<span class="ts">' + ago(n.ts) + '</span>';
    if (!n.read) html += '<div class="unread-dot" style="background:' + tc + ';"></div>';
    html += '</div>';
    // Title
    html += '<div class="title" style="font-weight:' + (n.read ? '600' : '800') + ';">' + n.title + '</div>';
    // Module + ref
    html += '<div class="module-ref"><span class="mod">' + n.module + '</span>';
    if (n.ref) html += ' Â· <span class="ref">' + n.ref + '</span>';
    html += '</div></div></div></div>';

    // Action buttons
    if (!actioned && n.actions) {
      html += '<div class="notif-actions">';
      if (n.actions.indexOf('approve') >= 0) {
        html += '<button class="notif-action-btn" style="background:#15803D;color:#fff;" onclick="event.stopPropagation();notifAction(\'' + n.id + '\',\'approve\')">âœ… Approve</button>';
      }
      if (n.actions.indexOf('reject') >= 0) {
        html += '<button class="notif-action-btn" style="background:#ef4444;color:#fff;" onclick="event.stopPropagation();notifAction(\'' + n.id + '\',\'reject\')">âŒ Reject</button>';
      }
      if (n.actions.indexOf('view') >= 0) {
        html += '<button class="notif-action-btn" style="background:var(--surf-mid);color:var(--text-c);border:1px solid var(--divider);" onclick="event.stopPropagation();markNotifRead(\'' + n.id + '\')">ğŸ‘ View</button>';
      }
      if (n.actions.indexOf('dismiss') >= 0) {
        html += '<button class="notif-action-btn" style="background:transparent;color:var(--text-d);border:1px solid var(--divider);margin-left:auto;" onclick="event.stopPropagation();dismissNotif(\'' + n.id + '\')">âœ• Dismiss</button>';
      }
      if (n.ref) {
        html += '<button class="notif-action-btn" style="border:1.5px solid var(--accent);background:var(--accent-light);color:var(--accent);margin-left:auto;" onclick="event.stopPropagation();">';
        html += '<span class="mono" style="font-weight:700;">' + n.ref + '</span> â†’ Open Record</button>';
      }
      html += '</div>';
    }
    html += '</div>';
  });
  html += '</div>';

  // Footer
  html += '<div class="notif-footer">';
  html += '<span class="info">NTF sheet Â· GAS-managed</span>';
  html += '<button class="view-all">View All â†’</button>';
  html += '</div></div>';

  // Backdrop
  html = '<div onclick="toggleNotifPanel()" style="position:fixed;inset:0;z-index:498;"></div>' + html;

  container.innerHTML = html;
}

function markNotifRead(id) {
  APP.notifications.forEach(function(n) {
    if (n.id === id) { n.read = true; n.status = 'read'; }
  });
  renderNotifPanel();
  updateNotifBadge();
  try { google.script.run.markNotificationRead(id); } catch(e) {}
}

function markAllNotifRead() {
  APP.notifications.forEach(function(n) { n.read = true; if (n.status === 'unread') n.status = 'read'; });
  renderNotifPanel();
  updateNotifBadge();
}

function notifAction(id, action) {
  APP.notifications.forEach(function(n) {
    if (n.id === id) { n.read = true; n.status = 'actioned'; n.actionTaken = action; }
  });
  renderNotifPanel();
  updateNotifBadge();
  showToast(action.charAt(0).toUpperCase() + action.slice(1) + 'd âœ“');
}

function dismissNotif(id) {
  APP.notifications = APP.notifications.filter(function(n) { return n.id !== id; });
  renderNotifPanel();
  updateNotifBadge();
  try { google.script.run.dismissNotification(id); } catch(e) {}
}

function expandNotif(id) {
  var n = APP.notifications.find(function(n) { return n.id === id; });
  if (n && !n.read) markNotifRead(id);
}


// â”€â”€â”€ COMMAND PALETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCommandPalette() {
  APP.cmdOpen = true;
  APP.cmdQuery = '';
  APP.cmdSel = 0;
  var overlay = $('cmdOverlay');
  overlay.classList.add('open');
  var input = $('cmdInput');
  input.value = '';
  input.focus();
  renderCmdResults('');
}

function closeCommandPalette(e) {
  if (e && e.target !== $('cmdOverlay')) return;
  APP.cmdOpen = false;
  $('cmdOverlay').classList.remove('open');
}

function filterCommands(q) {
  APP.cmdQuery = q;
  APP.cmdSel = 0;
  renderCmdResults(q);
}

function handleCmdKey(e) {
  var filtered = CMD_INDEX.filter(function(c) { return fuzzy(APP.cmdQuery, c.label + ' ' + c.sub + ' ' + c.group); });
  if (e.key === 'ArrowDown') { e.preventDefault(); APP.cmdSel = Math.min(APP.cmdSel + 1, filtered.length - 1); renderCmdResults(APP.cmdQuery); }
  if (e.key === 'ArrowUp')   { e.preventDefault(); APP.cmdSel = Math.max(APP.cmdSel - 1, 0); renderCmdResults(APP.cmdQuery); }
  if (e.key === 'Enter')     { e.preventDefault(); selectCmdItem(filtered[APP.cmdSel]); }
  if (e.key === 'Escape')    { closeCommandPalette(); }
}

function renderCmdResults(q) {
  var filtered = CMD_INDEX.filter(function(c) { return fuzzy(q, c.label + ' ' + c.sub + ' ' + c.group); });
  var groups = [];
  filtered.forEach(function(c) { if (groups.indexOf(c.group) < 0) groups.push(c.group); });

  var html = '';
  if (filtered.length === 0) {
    html = '<div style="padding:24px;text-align:center;color:var(--text-d);font-size:11px;">No results for "' + q + '"</div>';
  }
  var flatIdx = 0;
  groups.forEach(function(grp) {
    html += '<div class="cmd-group-label">' + grp + '</div>';
    var items = filtered.filter(function(c) { return c.group === grp; });
    items.forEach(function(item) {
      var isSelected = flatIdx === APP.cmdSel;
      var pinned = APP.shortcuts.some(function(s) { return s.mod === item.id || s.id === item.id; });
      html += '<div class="cmd-item' + (isSelected ? ' selected' : '') + '" onclick="selectCmdItem(CMD_INDEX.find(function(c){return c.id===\'' + item.id + '\'}))" onmouseenter="APP.cmdSel=' + flatIdx + ';renderCmdResults(APP.cmdQuery)">';
      html += '<span class="icon">' + item.icon + '</span>';
      html += '<div style="flex:1;"><div class="label">' + item.label + '</div><div class="sub">' + item.sub + '</div></div>';
      html += '<button class="pin-btn' + (pinned ? ' pinned' : '') + '" onclick="event.stopPropagation();pinFromCmd(\'' + item.id + '\')" title="' + (pinned ? 'Already pinned' : 'Pin to Quick Access') + '">' + (pinned ? 'â­' : 'â˜†') + '</button>';
      if (isSelected) html += '<span class="enter-badge">â†µ</span>';
      html += '</div>';
      flatIdx++;
    });
  });

  $('cmdResults').innerHTML = html;
}

function selectCmdItem(item) {
  if (!item) return;
  if (item.type === 'module') navigateTo(item.id);
  if (item.id === 'open-cfg') toggleSettingsPanel();
  if (item.id === 'mode-lg') applyThemeMode('lightgrey');
  if (item.id === 'mode-mid') applyThemeMode('midnight');
  if (item.id === 'mode-slate') applyThemeMode('slate');
  closeCommandPalette();
}

function pinFromCmd(id) {
  if (APP.shortcuts.some(function(s) { return s.mod === id || s.id === id; })) return;
  var item = CMD_INDEX.find(function(c) { return c.id === id; });
  if (!item) return;
  APP.shortcuts.push({
    id: 'sc' + Date.now(),
    icon: item.icon,
    label: item.label,
    mod: item.id || '',
    sub: item.group
  });
  renderQuickAccess();
  renderCmdResults(APP.cmdQuery);
  try { google.script.run.addShortcut(id); } catch(e) {}
}

// â”€â”€â”€ SETTINGS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSettingsPanel() {
  APP.cfgOpen = !APP.cfgOpen;
  APP.notifOpen = false;
  $('notifPanelContainer').innerHTML = '';
  updateNotifBadge();

  var overlay = $('settingsOverlay');
  var panel = $('settingsPanel');
  var btn = $('btnSettings');

  if (APP.cfgOpen) {
    APP.settingsDraft = JSON.parse(JSON.stringify(APP.cfg));
    overlay.classList.add('open');
    panel.classList.add('open');
    btn.classList.add('active');
    renderSettingsBody();
  } else {
    closeSettingsPanel();
  }
}

function closeSettingsPanel() {
  APP.cfgOpen = false;
  $('settingsOverlay').classList.remove('open');
  $('settingsPanel').classList.remove('open');
  var btn = $('btnSettings');
  if (btn) btn.classList.remove('active');
}

function renderSettingsBody() {
  var body = $('settingsBody');
  var d = APP.settingsDraft;
  var html = '';

  // Colour Mode
  html += '<div class="settings-section-label" style="border-top:none;padding-top:0;">Colour Mode</div>';
  html += '<div class="mode-cards">';
  Object.keys(MODES).forEach(function(key) {
    var m = MODES[key];
    var active = d.mode === key;
    var ac = ACCENTS[d.accent];
    html += '<div class="mode-card' + (active ? ' active' : '') + '" onclick="settingSet(\'mode\',\'' + key + '\')" style="border-color:' + (active ? ac.a : m.divider) + ';">';
    // Mini preview
    html += '<div style="height:56px;background:' + m.bg + ';overflow:hidden;">';
    html += '<div style="height:9px;background:' + m.shellBg + ';border-bottom:1px solid ' + m.shellBd + ';display:flex;align-items:center;gap:2px;padding:0 4px;">';
    html += '<div style="width:6px;height:4px;border-radius:1px;background:' + ac.a + ';"></div>';
    html += '<div style="width:12px;height:2px;border-radius:1px;background:' + m.textD + ';"></div>';
    html += '</div>';
    html += '<div style="display:flex;height:47px;">';
    html += '<div style="width:16px;background:' + m.sidebarBg + ';border-right:1px solid ' + m.sidebarBd + ';padding:2px;display:flex;flex-direction:column;gap:1px;">';
    for (var i = 0; i < 4; i++) {
      html += '<div style="height:3px;border-radius:1px;background:' + (i===0?ac.a:m.textD) + ';opacity:' + (i===0?'1':'.4') + ';"></div>';
    }
    html += '</div>';
    html += '<div style="flex:1;padding:3px 4px;display:flex;flex-direction:column;gap:2px;">';
    html += '<div style="display:flex;gap:2px;">';
    for (var j = 0; j < 4; j++) {
      html += '<div style="flex:1;height:7px;border-radius:2px;background:' + m.surfHigh + ';border:1px solid ' + m.divider + ';"></div>';
    }
    html += '</div>';
    html += '<div style="height:20px;border-radius:2px;background:' + m.surfHigh + ';border:1px solid ' + m.divider + ';"></div>';
    html += '</div></div></div>';
    // Label
    html += '<div style="padding:5px 6px;background:' + (active?ac.al:m.surfMid) + ';display:flex;align-items:center;gap:4px;">';
    html += '<span style="font-size:10px;">' + m.lbl + '</span>';
    html += '<span style="font-size:9px;font-weight:700;color:' + (active?ac.a:m.textB) + ';">' + m.name + '</span>';
    if (active) html += '<span style="margin-left:auto;font-size:7px;font-weight:900;color:' + ac.a + ';letter-spacing:.5px;">ACTIVE</span>';
    html += '</div></div>';
  });
  html += '</div>';

  // Accent Colour
  html += '<div class="settings-section-label">Accent Colour</div>';
  html += '<div class="accent-list">';
  Object.keys(ACCENTS).forEach(function(key) {
    var ac = ACCENTS[key];
    var active = d.accent === key;
    html += '<button class="accent-opt' + (active ? ' active' : '') + '" onclick="settingSet(\'accent\',\'' + key + '\')" style="border-color:' + (active ? ac.a : '') + ';background:' + (active ? ac.al : '') + ';">';
    html += '<div class="dot" style="background:' + ac.a + ';border:' + (active ? '2px solid var(--text-a)' : '2px solid transparent') + ';"></div>';
    html += '<span class="name">' + ac.lbl + '</span>';
    html += '<div class="bar" style="background:' + ac.a + ';"></div>';
    if (active) html += '<span class="active-lbl">ACTIVE</span>';
    html += '</button>';
  });
  html += '</div>';

  // Typography & Density
  html += '<div class="settings-section-label">Typography & Density</div>';
  html += '<div style="margin-bottom:8px;"><div style="font-size:9px;font-weight:900;color:var(--text-c);letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px;">Font Size</div>';
  html += '<div style="display:flex;gap:6px;flex-wrap:wrap;">';
  [['small','Small (11px)'],['medium','Medium (13px)'],['large','Large (15px)']].forEach(function(x) {
    html += '<button class="chip' + (d.fontSize===x[0]?' active':'') + '" onclick="settingSet(\'fontSize\',\'' + x[0] + '\')">' + x[1] + '</button>';
  });
  html += '</div></div>';
  html += '<div><div style="font-size:9px;font-weight:900;color:var(--text-c);letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px;">Row Density</div>';
  html += '<div style="display:flex;gap:6px;flex-wrap:wrap;">';
  [['compact','Compact'],['comfortable','Comfortable'],['spacious','Spacious']].forEach(function(x) {
    html += '<button class="chip' + (d.density===x[0]?' active':'') + '" onclick="settingSet(\'density\',\'' + x[0] + '\')">' + x[1] + '</button>';
  });
  html += '</div></div>';

  // Font Family
  html += '<div class="settings-section-label">Font Family</div>';
  html += '<div style="margin-bottom:12px;"><div style="font-size:9px;font-weight:900;color:var(--text-c);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;">UI Body Font</div>';
  UI_FONTS.forEach(function(f) {
    var active = d.uiFont === f.id;
    html += '<button class="font-opt' + (active?' active':'') + '" onclick="settingSet(\'uiFont\',\'' + f.id + '\')">';
    html += '<div style="flex:1;"><div class="preview-name" style="font-family:' + f.family + ';color:' + (active?'var(--accent)':'var(--text-a)') + ';">' + f.name + '</div>';
    html += '<div class="preview-sample" style="font-family:' + f.family + ';">The quick brown fox â€” ERP data entry</div></div>';
    html += '<div style="text-align:right;flex-shrink:0;"><div class="tag">' + f.tag + '</div>';
    if (active) html += '<div class="active-tag">ACTIVE</div>';
    html += '</div></button>';
  });
  html += '</div>';

  html += '<div style="margin-bottom:4px;"><div style="font-size:9px;font-weight:900;color:var(--text-c);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;">Data & Codes Font (Monospace)</div>';
  DATA_FONTS.forEach(function(f) {
    var active = d.dataFont === f.id;
    html += '<button class="font-opt' + (active?' active':'') + '" onclick="settingSet(\'dataFont\',\'' + f.id + '\')">';
    html += '<div style="flex:1;"><div class="preview-name" style="font-family:' + f.family + ';font-size:13px;color:' + (active?'var(--accent)':'var(--text-a)') + ';">' + f.name + '</div>';
    html += '<div class="preview-sample" style="font-family:' + f.family + ';">PO-2026-0042 Â· Rs.48,500 Â· GST 18%</div></div>';
    html += '<div style="text-align:right;flex-shrink:0;"><div class="tag">' + f.tag + '</div>';
    if (active) html += '<div class="active-tag">ACTIVE</div>';
    html += '</div></button>';
  });
  html += '</div>';

  // Table Style
  html += '<div class="settings-section-label">Table Style</div>';
  html += '<div style="display:flex;gap:6px;flex-wrap:wrap;">';
  [['striped','Striped'],['bordered','Bordered'],['clean','Clean']].forEach(function(x) {
    html += '<button class="chip' + (d.tblStyle===x[0]?' active':'') + '" onclick="settingSet(\'tblStyle\',\'' + x[0] + '\')">' + x[1] + '</button>';
  });
  html += '</div>';

  // Table preview
  var m = MODES[d.mode];
  var ac = ACCENTS[d.accent];
  html += '<div class="tbl-preview">';
  ['Header','Row 1','Row 2','Row 3'].forEach(function(lbl, i) {
    var isH = i === 0;
    var bg = isH ? m.tblHead : (d.tblStyle === 'striped' ? (i%2===1?m.tblEven:m.tblOdd) : m.surfHigh);
    html += '<div class="tbl-preview-row" style="background:' + bg + ';">';
    html += '<div class="tbl-preview-bar" style="width:24px;background:' + (isH?ac.a:m.textD) + ';opacity:.4;border-radius:2px;"></div>';
    html += '<div class="tbl-preview-bar" style="flex:1;background:' + m.textD + ';border-radius:2px;"></div>';
    html += '<div class="tbl-preview-bar" style="width:40px;background:' + m.textD + ';opacity:.25;border-radius:2px;"></div>';
    html += '</div>';
  });
  html += '</div>';

  // Display Toggles
  html += '<div class="settings-section-label">Display Toggles</div>';
  var toggles = [
    ['showStatusBar','Show Status Bar','Totals bar at the bottom of every module'],
    ['showThumbs','Show Thumbnails','Item image thumbnails in search dropdowns & tables'],
    ['showRowNums','Show Row Numbers','# column with sequential row numbers in tables'],
    ['showCatBadge','Show Category Badges','Coloured category pills on item rows'],
    ['compactSide','Compact Sidebar','Show icons only â€” no labels (saves space)']
  ];
  toggles.forEach(function(t) {
    var on = !!d[t[0]];
    html += '<div class="toggle-row">';
    html += '<div class="info"><div class="lbl">' + t[1] + '</div><div class="desc">' + t[2] + '</div></div>';
    html += '<div class="toggle' + (on?' on':'') + '" onclick="settingToggle(\'' + t[0] + '\')"><div class="knob"></div></div>';
    html += '</div>';
  });

  body.innerHTML = html;
}

function settingSet(key, val) {
  APP.settingsDraft[key] = val;
  renderSettingsBody();
}

function settingToggle(key) {
  APP.settingsDraft[key] = !APP.settingsDraft[key];
  renderSettingsBody();
}

function resetSettings() {
  APP.settingsDraft = JSON.parse(JSON.stringify(DEFAULTS));
  renderSettingsBody();
}

function applySettings() {
  APP.cfg = JSON.parse(JSON.stringify(APP.settingsDraft));
  applyTheme();
  renderSidebar();
  closeSettingsPanel();
  showToast('Settings applied âœ“');
  saveThemeToServer();
}

// â”€â”€â”€ PRESENCE / ONLINE USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendHeartbeat() {
  try {
    google.script.run.heartbeat(APP.activeModule || 'dashboard', APP.activePage || 'Home');
  } catch(e) {}
}

function loadOnlineUsers() {
  google.script.run
    .withSuccessHandler(function(data) {
      APP.onlineUsers = (data || []).map(function(u) {
        u.status = u.status || 'active';
        u.module = u.module || 'Dashboard';
        u.ts = u.ts || Date.now();
        return u;
      });
      renderShellAvatars();
      // Re-render dashboard if on it
      if (APP.activeModule === 'dashboard') {
        renderDashboard();
      }
    })
    .withFailureHandler(function() {
      // Use dummy data
      APP.onlineUsers = [
        {name:"Rajesh Kumar", email:"rajesh@cc.com",role:"Manager",   module:"Procurement",page:"PO-2026-0041",ts:Date.now()-18000, status:"active"},
        {name:"Amit Singh",   email:"amit@cc.com",  role:"Manager",   module:"Production", page:"WO-0089",     ts:Date.now()-5000,  status:"active"},
        {name:"Priya Sharma", email:"priya@cc.com", role:"Supervisor",module:"Quality",    page:"QC-0012",     ts:Date.now()-62000, status:"idle"},
        {name:"Ravi Verma",   email:"ravi@cc.com",  role:"Operator",  module:"Inventory",  page:"STK-0034",    ts:Date.now()-130000,status:"idle"},
        {name:"Anita Kaur",   email:"anita@cc.com", role:"View Only", module:"Dashboard",  page:"Home",        ts:Date.now()-22000, status:"active"}
      ];
      renderShellAvatars();
    })
    .getOnlineUsers();

  // Refresh every 60s
  setTimeout(loadOnlineUsers, 60000);
}

// â”€â”€â”€ GLOBAL KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleGlobalKey(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    if (APP.cmdOpen) { closeCommandPalette(); } else { openCommandPalette(); }
  }
  if (e.key === 'Escape') {
    if (APP.cmdOpen) closeCommandPalette();
    if (APP.notifOpen) toggleNotifPanel();
    if (APP.cfgOpen) closeSettingsPanel();
  }
}

// â”€â”€â”€ CLOSE ALL DROPDOWNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeAllDropdowns() {
  APP.showAllUsers = false;
  $('globalBackdrop').style.display = 'none';
}

// â”€â”€â”€ INIT ON LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
  buildCmdIndex();
  initApp();
});
</script>
